<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Crear Cita</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 500px;
        margin: 30px auto;
        padding: 10px;
        background-color: #f9f9f9;
        border-radius: 8px;
      }
      label {
        display: block;
        margin-top: 15px;
        font-weight: bold;
      }
      select,
      input[type="date"],
      textarea,
      button {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        box-sizing: border-box;
        border-radius: 4px;
        border: 1px solid #ccc;
      }
      button {
        margin-top: 20px;
        background-color: #28a745;
        color: white;
        font-size: 16px;
        cursor: pointer;
        border: none;
      }
      button:hover {
        background-color: #218838;
      }
    </style>
  </head>
  <body>
    <form id="formCrearCita" class="form-cita">
      <h2>Crear Nueva Cita</h2>

      <label for="doctor">Doctor:</label>
      <select id="doctor" name="doctor" required>
        <option value="">Cargando doctores...</option>
      </select>

      <label for="fecha">Fecha:</label>
      <input type="date" id="fecha" name="fecha" required />

      <label for="hora">Hora:</label>
      <select id="hora" name="hora" required disabled>
        <option value="">Seleccione una hora</option>
      </select>

      <label for="descripcion">Descripción:</label>
      <textarea
        id="descripcion"
        name="descripcion"
        rows="3"
        placeholder="Opcional"
      ></textarea>

      <button type="submit">Crear Cita</button>
    </form>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const selectDoctor = document.getElementById("doctor");
        const inputFecha = document.getElementById("fecha");
        const selectHora = document.getElementById("hora");

        // Token para usar en fetchs (Bearer incluido)
        const token =
          "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhYUBhYS5jb20iLCJpZF91c2VyIjoxNywiZnVsbF9uYW1lIjoiV2lsc29uIE1hbnVlbCBFc3RyYWRhIE9ydGVnYSIsImVtYWlsIjoiYWFAYWEuY29tIiwicm9sZSI6IlBhdGllbnQiLCJleHAiOjE3NDg0MDQ4ODR9.vwHDaPHSSe6fyROcXEGbPM1s9l8BytAOlfHp3HlYGHY";

        // Función para cargar doctores desde API
        function cargarDoctores() {
          fetch("http://127.0.0.1:8000/doctors", {
            headers: {
              accept: "application/json",
              Authorization: token,
            },
          })
            .then((res) => {
              if (!res.ok)
                throw new Error(`Error al cargar doctores: ${res.status}`);
              return res.json();
            })
            .then((doctores) => {
              selectDoctor.innerHTML =
                '<option value="">Seleccione un doctor</option>';
              doctores.forEach((doc) => {
                const option = document.createElement("option");
                option.value = doc.id_doctor;
                option.textContent = doc.full_name;
                selectDoctor.appendChild(option);
              });
            })
            .catch((e) => {
              console.error(e);
              selectDoctor.innerHTML =
                '<option value="">No se pudieron cargar los doctores</option>';
            });
        }

        // Función para cargar horas disponibles del doctor y fecha seleccionada
        function cargarHorasDisponibles() {
          const idDoctor = parseInt(selectDoctor.value, 10);
          const fecha = inputFecha.value;

          if (!idDoctor || !fecha) {
            selectHora.innerHTML =
              '<option value="">Seleccione una hora</option>';
            selectHora.disabled = true;
            return;
          }

          fetch("http://127.0.0.1:8000/doctors/schedule", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              accept: "application/json",
              Authorization: token,
            },
            body: JSON.stringify({ id_doctor: idDoctor, date: fecha }),
          })
            .then((res) => {
              if (!res.ok) throw new Error(`Error ${res.status}`);
              return res.json();
            })
            .then((horas) => {
              selectHora.innerHTML = "";
              if (horas.length === 0) {
                selectHora.innerHTML =
                  '<option value="">No hay horas disponibles</option>';
                selectHora.disabled = true;
                return;
              }
              horas.forEach((hora) => {
                const option = document.createElement("option");
                option.value = hora;
                option.textContent = hora;
                selectHora.appendChild(option);
              });
              selectHora.disabled = false;
            })
            .catch((e) => {
              console.error("Error en fetch:", e);
              alert("No se pudieron cargar las horas disponibles.");
            });
        }

        // Carga doctores al inicio
        cargarDoctores();

        // Eventos para actualizar horas disponibles cuando cambia doctor o fecha
        selectDoctor.addEventListener("change", cargarHorasDisponibles);
        inputFecha.addEventListener("change", cargarHorasDisponibles);

        // Manejo del envío del formulario para crear cita
        document
          .getElementById("formCrearCita")
          .addEventListener("submit", function (e) {
            e.preventDefault();

            const data = {
              id_doctor: parseInt(selectDoctor.value),
              id_patient: 17, // Cambiar si tienes el ID real del paciente
              date: inputFecha.value,
              time: selectHora.value,
              description: document.getElementById("descripcion").value,
            };

            fetch("http://127.0.0.1:8000/appointments", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: token,
              },
              body: JSON.stringify(data),
            })
              .then((res) => {
                if (!res.ok) throw new Error("Error en la respuesta");
                return res.json();
              })
              .then(() => {
                alert("✅ Cita creada exitosamente");
                document.getElementById("formCrearCita").reset();
                selectHora.innerHTML =
                  '<option value="">Seleccione una hora</option>';
                selectHora.disabled = true;
              })
              .catch((error) => {
                console.error("❌ Error al crear cita:", error);
                alert("Error al crear la cita. Revisa la consola.");
              });
          });
      });
    </script>
  </body>
</html>
